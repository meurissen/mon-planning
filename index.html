<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planner Pro Famille v6</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f5f6fa; --dark: #2c3e50; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 15px 100px 15px; color: var(--dark); -webkit-user-select: none; }
        h1 { text-align: center; font-size: 20px; margin: 15px 0; }
        
        /* Navigation Date */
        .date-nav { display: flex; align-items: center; justify-content: space-between; background: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .date-nav button { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; }
        .date-nav input { border: none; font-size: 16px; font-weight: bold; text-align: center; width: 140px; background: transparent; }

        /* Formulaire Masqu√© (Modal) */
        #formOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
        .card { background: white; border-radius: 25px 25px 0 0; padding: 20px; width: 100%; box-sizing: border-box; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .label { font-size: 10px; font-weight: 800; color: #bdc3c7; margin-bottom: 5px; text-transform: uppercase; margin-top: 10px; }
        input[type="text"], input[type="time"], input[type="number"] { width: 100%; border: none; border-bottom: 2px solid #f1f2f6; padding: 10px 0; margin-bottom: 5px; font-size: 16px; outline: none; }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }
        
        /* Grilles Ic√¥nes et Couleurs */
        .selection-grid { display: flex; overflow-x: auto; gap: 8px; padding: 5px 0; margin-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .icon-item { padding: 10px; background: #f8f9fa; border-radius: 10px; font-size: 22px; border: 2px solid transparent; flex-shrink: 0; min-width: 40px; text-align: center; }
        .icon-item.selected { border-color: var(--primary); background: #e1f5fe; }
        .color-item { width: 32px; height: 32px; border-radius: 50%; border: 3px solid transparent; flex-shrink: 0; }
        .color-item.selected { border-color: #2c3e50; transform: scale(1.1); }

        /* Boutons */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; color: white; font-weight: bold; font-size: 15px; margin-top: 10px; cursor: pointer; }
        .btn-add { background: var(--success); }
        .btn-edit { background: var(--warning); }
        .btn-cancel { background: #eee; color: #666; margin-top: 5px; }

        /* Bouton Flottant + */
        .fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); z-index: 900; border: none; font-weight: bold; }

        /* T√¢ches */
        .task-card { display: flex; align-items: center; background: white; padding: 12px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border-left: 8px solid var(--primary); }
        .task-emoji { font-size: 24px; margin-right: 12px; }
        .task-info { flex: 1; }
        .task-title { font-weight: bold; margin: 0 0 4px 0; font-size: 15px; }
        .time-box { display: flex; gap: 8px; font-size: 11px; font-weight: bold; }
        .t-dep { color: #e67e22; }
        .t-arr { color: var(--primary); }
        .t-end { color: var(--success); }

        .actions { display: flex; gap: 4px; }
        .actions button { background: none; border: none; font-size: 18px; padding: 5px; }
        
        #banner { display: none; background: #2c3e50; color: white; padding: 12px; border-radius: 10px; text-align: center; margin-bottom: 10px; font-size: 13px; position: sticky; top: 10px; z-index: 100; }
    </style>
</head>
<body>

    <h1>Mon Planner Pro üöÄ</h1>

    <div id="banner"></div>

    <div class="date-nav">
        <button onclick="changeDate(-1)">‚Üê</button>
        <input type="date" id="dateInput" onchange="render()">
        <button onclick="changeDate(1)">‚Üí</button>
    </div>

    <div id="taskList"></div>

    <button class="fab" onclick="toggleForm(true)">+</button>

    <div id="formOverlay" onclick="if(event.target == this) toggleForm(false)">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="formTitle" style="margin:0">Nouvelle Activit√©</h3>
                <button onclick="toggleForm(false)" style="background:none; border:none; font-size:20px;">‚úï</button>
            </div>
            
            <div class="label">Nom</div>
            <input type="text" id="titleInput" placeholder="Ex: Piscine, Client...">
            
            <div class="row">
                <div><div class="label">Arriv√©e</div><input type="time" id="arrivalTime" value="09:00"></div>
                <div><div class="label">Trajet (min)</div><input type="number" id="travelInput" value="20"></div>
                <div><div class="label">Dur√©e (min)</div><input type="number" id="durationInput" value="60"></div>
            </div>
            
            <div class="label">Ic√¥ne</div>
            <div class="selection-grid" id="iconGrid"></div>

            <div class="label">Couleur</div>
            <div class="selection-grid" id="colorGrid"></div>

            <button class="btn btn-add" id="mainBtn" onclick="saveTask()">PROGRAMMER</button>
            <button class="btn btn-cancel" id="copyDayBtn" onclick="prepareCopy('day')">DUPLIQUER LA JOURN√âE</button>
            <button class="btn btn-cancel" onclick="exportData()">üíæ EXPORT JSON</button>
            <button class="btn btn-cancel" onclick="toggleForm(false)">FERMER</button>
        </div>
    </div>

    <script>
        // Utilisation continue de planner_v6_tasks
        let tasks = JSON.parse(localStorage.getItem('planner_v6_tasks')) || {};
        let selectedIcon = 'üíº';
        let selectedColor = '#3498db';
        let editingId = null;
        let dataToCopy = null;
        let copyMode = null;

        const icons = ['üíº', 'üè†', 'üöó', 'ü©∫', 'üèä', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', '‚öΩ', 'üèÉ', 'üõí', 'üéì', 'üçï', 'üß∏', 'üîß'];
        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'];

        const dateInput = document.getElementById('dateInput');
        dateInput.value = new Date().toISOString().split('T')[0];

        function toggleForm(show) {
            document.getElementById('formOverlay').style.display = show ? 'flex' : 'none';
            if(!show) resetForm();
        }

        function setupSelection() {
            const iGrid = document.getElementById('iconGrid'); iGrid.innerHTML = '';
            icons.forEach(icon => {
                const div = document.createElement('div');
                div.className = `icon-item ${icon === selectedIcon ? 'selected' : ''}`;
                div.innerHTML = icon;
                div.onclick = () => { selectedIcon = icon; setupSelection(); };
                iGrid.appendChild(div);
            });

            const cGrid = document.getElementById('colorGrid'); cGrid.innerHTML = '';
            colors.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-item ${color === selectedColor ? 'selected' : ''}`;
                div.style.backgroundColor = color;
                div.onclick = () => { selectedColor = color; setupSelection(); };
                cGrid.appendChild(div);
            });
        }

        function changeDate(days) {
            let d = new Date(dateInput.value);
            d.setDate(d.getDate() + days);
            dateInput.value = d.toISOString().split('T')[0];
            render();
        }

        function adjustTime(timeStr, minutes) {
            let [h, m] = timeStr.split(':').map(Number);
            let total = h * 60 + m + parseInt(minutes);
            if (total < 0) total += 1440;
            if (total >= 1440) total -= 1440;
            return `${Math.floor(total/60).toString().padStart(2,'0')}:${(total%60).toString().padStart(2,'0')}`;
        }

        function saveTask() {
            const date = dateInput.value;
            const title = document.getElementById('titleInput').value;
            if (!title) return;

            const arrival = document.getElementById('arrivalTime').value;
            const travel = document.getElementById('travelInput').value;
            const duration = document.getElementById('durationInput').value;
            
            const taskData = { 
                id: editingId || Date.now(), title, arrival, travel, duration, 
                departure: adjustTime(arrival, -travel), end: adjustTime(arrival, duration),
                icon: selectedIcon, color: selectedColor 
            };

            if (!tasks[date]) tasks[date] = [];
            if (editingId) tasks[date] = tasks[date].map(t => t.id === editingId ? taskData : t);
            else tasks[date].push(taskData);

            tasks[date].sort((a, b) => a.departure.localeCompare(b.departure));
            localStorage.setItem('planner_v6_tasks', JSON.stringify(tasks));
            toggleForm(false); render();
        }

        function editTask(id) {
            const date = dateInput.value;
            const task = tasks[date].find(t => t.id === id);
            editingId = id;
            document.getElementById('titleInput').value = task.title;
            document.getElementById('arrivalTime').value = task.arrival;
            document.getElementById('travelInput').value = task.travel || 0;
            document.getElementById('durationInput').value = task.duration || 0;
            selectedIcon = task.icon; selectedColor = task.color;
            setupSelection();
            document.getElementById('mainBtn').innerText = "MODIFIER";
            document.getElementById('formTitle').innerText = "Modifier l'activit√©";
            toggleForm(true);
        }

        function resetForm() {
            editingId = null;
            document.getElementById('titleInput').value = '';
            document.getElementById('mainBtn').innerText = "PROGRAMMER";
            document.getElementById('formTitle').innerText = "Nouvelle Activit√©";
        }

        function prepareCopy(mode, taskData = null) {
            copyMode = mode;
            if (mode === 'day') {
                const date = dateInput.value;
                if (!tasks[date] || tasks[date].length === 0) return;
                dataToCopy = [...tasks[date]];
                toggleForm(false);
                document.getElementById('banner').innerHTML = "üìã Journ√©e copi√©e ! Changez de date.";
            } else {
                dataToCopy = {...taskData};
                document.getElementById('banner').innerHTML = `üìã "${taskData.title}" copi√© !`;
            }
            document.getElementById('banner').style.display = 'block';
        }

        function deleteTask(date, id) {
            if(confirm("Supprimer ?")) {
                tasks[date] = tasks[date].filter(t => t.id !== id);
                localStorage.setItem('planner_v6_tasks', JSON.stringify(tasks));
                render();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr);
            dl.setAttribute("download", "planner_backup.json"); dl.click();
        }

        function render() {
            const date = dateInput.value;
            const banner = document.getElementById('banner');

            if (dataToCopy) {
                if (copyMode === 'day') tasks[date] = dataToCopy.map(t => ({...t, id: Math.random()}));
                else { if (!tasks[date]) tasks[date] = []; tasks[date].push({...dataToCopy, id: Math.random()}); }
                tasks[date].sort((a, b) => a.departure.localeCompare(b.departure));
                localStorage.setItem('planner_v6_tasks', JSON.stringify(tasks));
                dataToCopy = null; banner.style.display = 'none';
            }

            const container = document.getElementById('taskList');
            const dayLabel = new Date(date).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
            container.innerHTML = `<div style="font-weight:bold; color:#7f8c8d; margin-bottom:15px; text-transform:capitalize;">${dayLabel}</div>`;
            
            const dayTasks = tasks[date] || [];
            dayTasks.forEach(task => {
                container.innerHTML += `
                    <div class="task-card" style="border-left-color: ${task.color}">
                        <div class="task-emoji">${task.icon}</div>
                        <div class="task-info">
                            <p class="task-title">${task.title}</p>
                            <div class="time-box">
                                <span class="t-dep">üöó ${task.departure}</span>
                                <span class="t-arr">üìç ${task.arrival}</span>
                                <span class="t-end">üèÅ ${task.end}</span>
                            </div>
                        </div>
                        <div class="actions">
                            <button onclick='prepareCopy("task", ${JSON.stringify(task)})'>üìã</button>
                            <button onclick="editTask(${task.id})">‚úèÔ∏è</button>
                            <button onclick="deleteTask('${date}', ${task.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
        }
        setupSelection(); render();
    </script>
</body>
</html>
